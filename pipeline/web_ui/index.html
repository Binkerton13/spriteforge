<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Character Pipeline - Project Manager</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fflate@0.7.4/umd/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>üé¨ 3D Character Pipeline</h1>
                <div class="project-selector">
                    <select id="projectSelect" onchange="loadProject(this.value)">
                        <option value="">Select Project...</option>
                    </select>
                    <button class="btn btn-primary" onclick="showNewProjectDialog()">+ New Project</button>
                    <button class="btn btn-secondary" onclick="showComfyUISetup()" title="View required ComfyUI setup">‚öôÔ∏è ComfyUI Setup</button>
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">
                        <span id="themeIcon">üåô</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Sidebar - File Upload -->
            <div class="sidebar sidebar-left">
                <h2>üìÇ Input Files</h2>
                
                <!-- Character Mesh Upload -->
                <div class="upload-section">
                    <h3>Character Mesh</h3>
                    <div class="drop-zone" id="meshDropZone" 
                         ondrop="handleDrop(event, 'mesh')" 
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)">
                        <div class="drop-zone-content">
                            <span class="drop-icon">üì¶</span>
                            <p>Drop FBX/OBJ file here</p>
                            <input type="file" id="meshInput" accept=".fbx,.obj" onchange="handleFileSelect(event, 'mesh')" style="display: none">
                            <button class="btn btn-small" onclick="document.getElementById('meshInput').click()">Browse</button>
                        </div>
                        <div class="file-info" id="meshInfo" style="display: none"></div>
                    </div>
                    <div class="form-group" id="previousMeshGroup" style="display: none; margin-top: 0.5rem;">
                        <label for="previousMeshSelect">Or select uploaded file:</label>
                        <select id="previousMeshSelect" onchange="selectPreviousMesh(this.value)">
                            <option value="">-- Choose file --</option>
                        </select>
                    </div>
                    <div class="form-group" id="meshTypeGroup" style="display: none; margin-top: 1rem;">
                        <label for="meshTypeSelect">Mesh Type</label>
                        <select id="meshTypeSelect" onchange="updateMeshType(this.value)">
                            <option value="skeletal">Skeletal (Rigging + Animation)</option>
                            <option value="static">Static (Texture Only)</option>
                        </select>
                        <small>Static meshes skip rigging and animation steps</small>
                    </div>
                </div>

                <!-- UDIM Tiles Upload -->
                <div class="upload-section">
                    <h3 title="Upload UDIM texture tiles (1001, 1002, etc.)">UDIM Tiles</h3>
                    <div class="drop-zone" id="udimDropZone"
                         ondrop="handleDrop(event, 'udim')"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         title="Drop UDIM PNG texture files (naming: 1001.png, 1002.png, etc.)">
                        <div class="drop-zone-content">
                            <span class="drop-icon">üñºÔ∏è</span>
                            <p>Drop UDIM PNG files here</p>
                            <input type="file" id="udimInput" accept=".png" multiple onchange="handleFileSelect(event, 'udim')" style="display: none">
                            <button class="btn btn-small" onclick="document.getElementById('udimInput').click()" title="Browse for UDIM tiles">Browse</button>
                        </div>
                        <div id="udimList" class="file-list"></div>
                    </div>
                </div>

                <!-- Style References -->
                <div class="upload-section">
                    <h3 title="Upload reference images for character appearance consistency (used by IP-Adapter)">Character References</h3>
                    <div class="drop-zone" id="styleRefDropZone"
                         ondrop="handleDrop(event, 'style_reference')"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         title="Drop character reference images for consistent appearance in sprite generation">
                        <div class="drop-zone-content">
                            <span class="drop-icon">üé®</span>
                            <p>Character references (for sprite consistency)</p>
                            <input type="file" id="styleRefInput" accept="image/*" multiple onchange="handleFileSelect(event, 'style_reference')" style="display: none">
                            <button class="btn btn-small" onclick="document.getElementById('styleRefInput').click()" title="Browse for character references">Browse</button>
                        </div>
                        <div id="styleRefList" class="file-list"></div>
                    </div>
                </div>

                <!-- Pose/Motion References -->
                <div class="upload-section">
                    <h3>Pose References</h3>
                    <div class="drop-zone" id="poseRefDropZone"
                         ondrop="handleDrop(event, 'pose_reference')"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)">
                        <div class="drop-zone-content">
                            <span class="drop-icon">üßò</span>
                            <p>Motion/pose references</p>
                            <input type="file" id="poseRefInput" accept="image/*" multiple onchange="handleFileSelect(event, 'pose_reference')" style="display: none">
                            <button class="btn btn-small" onclick="document.getElementById('poseRefInput').click()">Browse</button>
                        </div>
                        <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">Tip: Use OpenPose, DWPose, or depth maps for best results</small>
                        <div id="poseRefList" class="file-list"></div>
                    </div>
                </div>

                <!-- ComfyUI Models Management -->
                <div class="upload-section">
                    <h3>ü§ñ ComfyUI Models</h3>
                    <button class="btn btn-small" onclick="toggleModelManager()" style="width: 100%; margin-bottom: 0.5rem;">
                        üì¶ Manage Models
                    </button>
                    <div id="modelValidation" class="model-validation" style="display: none;">
                        <div class="validation-item" id="textureValidation">
                            <span class="validation-icon">‚è≥</span>
                            <span>Texture Workflow</span>
                        </div>
                        <div class="validation-item" id="spriteValidation">
                            <span class="validation-icon">‚è≥</span>
                            <span>Sprite Workflow</span>
                        </div>
                    </div>
                </div>

                <!-- Upload Progress -->
                <div id="uploadProgress" style="display: none">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="progressText">Uploading...</p>
                </div>
            </div>

            <!-- Center - 3D Viewer -->
            <div class="viewer-container">
                <div class="viewer-header">
                    <h2 id="viewerTitle">üé® Model Viewer</h2>
                    <div class="viewer-controls">
                        <select id="imageTypeSelector" style="display: none;" onchange="switchImageType(this.value)">
                            <option value="udim">UDIM Tiles</option>
                            <option value="style">Style References</option>
                            <option value="pose">Pose References</option>
                            <option value="textures">Generated Textures</option>
                        </select>
                        <button class="btn btn-small" id="viewModeToggle" onclick="toggleViewMode()">üñºÔ∏è Image View</button>
                        <button class="btn btn-small" id="materialViewBtn" onclick="toggleMaterialView()" style="display: none;">üé® Material View</button>
                        <button class="btn btn-small" id="resetViewBtn" onclick="resetCamera()">‚Üª Reset View</button>
                        <button class="btn btn-small" id="wireframeBtn" onclick="toggleWireframe()">‚¨ö Wireframe</button>
                        <button class="btn btn-small" id="gridBtn" onclick="toggleGrid()">‚äû Grid</button>
                    </div>
                </div>
                <div id="viewer3d" class="viewer-canvas">
                    <div class="animation-controls" id="animControls" style="display: none;">
                        <button class="anim-btn" id="playPauseBtn" onclick="toggleAnimation()">‚ñ∂Ô∏è</button>
                        <input type="range" id="animSlider" min="0" max="100" value="0" oninput="seekAnimation(this.value)">
                        <span id="animTime">0:00 / 0:00</span>
                    </div>
                </div>
                <div id="imageViewer" class="viewer-canvas" style="display: none;">
                    <div class="image-viewer-content">
                        <div id="imageViewerGrid" class="image-grid"></div>
                        <div id="imageViewerSingle" class="image-single" style="display: none;">
                            <img id="imageViewerImg" src="" alt="Preview">
                        </div>
                    </div>
                </div>
                <div class="viewer-info">
                    <span id="vertexCount">Vertices: -</span>
                    <span id="faceCount">Faces: -</span>
                    <span id="meshFormat">Format: -</span>
                    <span id="imageCount" style="display: none;">Images: -</span>
                </div>
            </div>

            <!-- Right Sidebar - Configuration -->
            <div class="sidebar sidebar-right">
                <h2>‚öôÔ∏è Configuration</h2>
                
                <!-- Project Settings -->
                <div class="config-section">
                    <h3>Project Settings</h3>
                    <div class="form-group">
                        <label for="projectNameInput">Project Name</label>
                        <input type="text" id="projectNameInput" placeholder="MyCharacter" disabled>
                    </div>
                </div>

                <!-- Texture Generation - ARCHIVED -->
                <!-- Texture generation removed - use archive/texture_generation/ if needed -->
                <!-- Pipeline now focuses on sprite generation for 3D action games -->

                <!-- Rig Settings -->
                <div class="config-section">
                    <h3>Rigging</h3>
                    <div class="form-group">
                        <label for="rigPreset" title="Choose bone structure preset for auto-rigging">Preset</label>
                        <select id="rigPreset" title="Humanoid: Human character skeleton. Creature: Custom bone setup.">
                            <option value="humanoid_standard">Humanoid Standard</option>
                            <option value="humanoid_game">Humanoid Game</option>
                            <option value="creature">Creature</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rigScale" title="Uniform scale factor for the rig">Scale</label>
                        <input type="number" id="rigScale" value="1.0" step="0.1" title="1.0 = original size">
                    </div>
                    <div class="form-group">
                        <label for="rigOrientation" title="World space orientation for the character">Orientation</label>
                        <select id="rigOrientation" title="Y-Up: Standard for most game engines. Z-Up: CAD and some 3D apps.">
                            <option value="Y_UP">Y-Up</option>
                            <option value="Z_UP">Z-Up</option>
                        </select>
                    </div>
                </div>

                <!-- Animation Settings -->
                <div class="config-section">
                    <h3>Animation</h3>
                    
                    <!-- Animation Mode Selector -->
                    <div class="form-group">
                        <label for="animMode">Mode</label>
                        <select id="animMode" onchange="toggleAnimationMode(this.value)">
                            <option value="library">Library Selection</option>
                            <option value="custom">Custom Prompt</option>
                        </select>
                    </div>
                    
                    <!-- Animation Library Selector -->
                    <div id="libraryMode" style="display: block;">
                        <div class="form-group">
                            <label>Select Animations</label>
                            <div class="animation-selection-info">
                                <span id="selectedAnimCount">0 selected</span>
                                <div>
                                    <button type="button" class="btn-text" onclick="openPromptEditor()" title="Edit prompts for selected animations">‚úèÔ∏è Edit Prompts</button>
                                    <button type="button" class="btn-text" onclick="clearAllAnimations()" title="Deselect all animations">Clear All</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="animationWarning" class="warning-box" style="display: none;">
                            ‚ö†Ô∏è <span id="warningText">Multiple animations selected</span>
                        </div>
                        
                        <div id="animationCheckboxes" class="animation-checkbox-container">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                    
                    <!-- Custom Prompt Mode -->
                    <div id="customMode" style="display: none;">
                        <!-- Motion Prompt Fields -->
                        <div class="form-group">
                            <label for="motionField">Motion</label>
                            <textarea id="motionField" rows="3" placeholder="Describe the primary motion and mechanics"></textarea>
                        </div>
                    
                    <div class="form-group">
                        <label for="styleField">Style</label>
                        <textarea id="styleField" rows="2" placeholder="Animation style and characteristics"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="constraintsField">Constraints</label>
                        <textarea id="constraintsField" rows="2" placeholder="Technical constraints and requirements"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="cameraField">Camera</label>
                        <input type="text" id="cameraField" value="Locked." placeholder="Camera behavior">
                    </div>
                    
                        <div class="form-group">
                            <label for="outputField">Output</label>
                            <input type="text" id="outputField" value="30 frames, 30fps." placeholder="Duration and frame rate">
                        </div>
                    </div>
                </div>

                <!-- Sprite Generation -->
                <div class="config-section" id="spriteSection">
                    <h3>2D Sprite Generation (3D Action Game Style)</h3>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableSprites" onchange="toggleSpriteOptions(this.checked)">
                            Enable sprite generation from animation
                        </label>
                    </div>
                    
                    <div id="spriteOptions" style="display: none;">
                        <!-- Quality Preset -->
                        <div class="form-group">
                            <label for="spriteQualityPreset">Quality Preset</label>
                            <select id="spriteQualityPreset" onchange="updateQualitySettings()">
                                <option value="fast">Fast Prototype (256px, 12fps, ~2-3 sec/frame)</option>
                                <option value="balanced" selected>Balanced (512px, 16fps, ~5-8 sec/frame)</option>
                                <option value="high">High Quality (512px, 24fps, ~15-20 sec/frame)</option>
                                <option value="ultra">Ultra Quality (1024px, 30fps, ~30-40 sec/frame)</option>
                            </select>
                            <small>Affects resolution, frame rate, and AI steps</small>
                        </div>

                        <!-- Camera Preset -->
                        <div class="form-group">
                            <label for="spriteCameraPreset">Camera Preset</label>
                            <select id="spriteCameraPreset" onchange="updateCameraAngles()">
                                <option value="isometric_4way" selected>Isometric 4-way (Diablo style)</option>
                                <option value="isometric_8way">Isometric 8-way (Full movement)</option>
                                <option value="threequarter_8way">3/4 View 8-way (More detail)</option>
                                <option value="sidescroller_2way">Side-scroller 2-way (Platformer)</option>
                            </select>
                            <small>Determines viewing angles for sprites</small>
                        </div>

                        <!-- Character References -->
                        <div class="form-group">
                            <label for="spriteReferenceImages">Character Reference Images (IP-Adapter)</label>
                            <div class="drop-zone" id="spriteReferenceDrop" 
                                 ondrop="handleSpriteReferenceDrop(event)" 
                                 ondragover="event.preventDefault()" 
                                 ondragenter="event.currentTarget.classList.add('drag-over')" 
                                 ondragleave="event.currentTarget.classList.remove('drag-over')">
                                <p>Drop character reference images here</p>
                                <p style="font-size: 0.85em; color: var(--text-secondary);">For consistent character appearance</p>
                                <input type="file" id="spriteReferenceImages" accept="image/*" multiple style="display: none;" onchange="handleSpriteReferenceFiles(this.files)">
                                <button type="button" onclick="document.getElementById('spriteReferenceImages').click()" class="btn-secondary">Select Files</button>
                            </div>
                            <div id="spriteReferencePreview" class="reference-preview"></div>
                        </div>

                        <!-- Character Prompt -->
                        <div class="form-group">
                            <label for="spriteCharacterPrompt">Character Appearance Prompt</label>
                            <textarea id="spriteCharacterPrompt" rows="4" placeholder="female warrior, long red hair, leather armor with metal pauldrons, determined expression, fantasy style"></textarea>
                            <small>Describe character appearance for AI enhancement (uses 3D model as base)</small>
                        </div>

                        <!-- Style Tags -->
                        <div class="form-group">
                            <label>Style Enhancement</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="styleStylized" checked> Stylized Realistic</label>
                                <label><input type="checkbox" id="styleCelShaded"> Cel-Shaded</label>
                                <label><input type="checkbox" id="stylePainterly"> Painterly</label>
                                <label><input type="checkbox" id="styleHandDrawn"> Hand-Drawn</label>
                                <label><input type="checkbox" id="stylePixelArt"> Pixel Art</label>
                            </div>
                        </div>

                        <!-- Advanced Settings (collapsible) -->
                        <details>
                            <summary>Advanced Settings</summary>
                            
                            <div class="form-group">
                                <label for="spriteResolution">Output Resolution Override</label>
                                <select id="spriteResolution">
                                    <option value="auto" selected>Auto (from quality preset)</option>
                                    <option value="256">256x256</option>
                                    <option value="512">512x512</option>
                                    <option value="768">768x768</option>
                                    <option value="1024">1024x1024</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="spriteFrameRate">Frame Rate Override</label>
                                <select id="spriteFrameRate">
                                    <option value="auto" selected>Auto (from quality preset)</option>
                                    <option value="8">8 fps</option>
                                    <option value="12">12 fps</option>
                                    <option value="16">16 fps</option>
                                    <option value="24">24 fps</option>
                                    <option value="30">30 fps</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="spriteNegativePrompt">Negative Prompt</label>
                                <textarea id="spriteNegativePrompt" rows="2" placeholder="low quality, blurry, distorted, deformed, bad anatomy, extra limbs"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="spriteSeed">Random Seed</label>
                                <input type="number" id="spriteSeed" placeholder="Random (leave empty)" min="-1">
                                <small>Set specific seed for reproducible results</small>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="spriteBackgroundRemoval" checked>
                                    Remove background (transparent sprites)
                                </label>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="spriteShadowBaking" checked>
                                    Bake contact shadows
                                </label>
                            </div>
                        </details>

                        <!-- Sprite Sheet Options -->
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="spriteSpritesheet" checked>
                                Generate sprite sheets (combined frames per angle)
                            </label>
                        </div>
                    </div>
                </div>

                <!-- References -->
                <div class="config-section">
                    <h3>References</h3>
                    <div class="reference-summary">
                        <div class="ref-count">
                            <span id="styleRefCount">Style: 0</span>
                            <span id="poseRefCount">Pose: 0</span>
                        </div>
                        <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">Use Image View dropdown to preview references</small>
                    </div>
                </div>

                <!-- Export Settings -->
                <div class="config-section">
                    <h3>Export</h3>
                    <div class="form-group">
                        <label for="exportFormat">Format</label>
                        <select id="exportFormat">
                            <option value="fbx">FBX</option>
                            <option value="obj">OBJ</option>
                            <option value="glb">GLB</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="exportPackage" checked>
                            Create package archive
                        </label>
                    </div>
                </div>

                <!-- Pipeline Execution -->
                <div class="config-section">
                    <h3>Pipeline Execution</h3>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <button class="btn btn-primary btn-large" onclick="runPipeline(false)" id="runPipelineBtn" style="flex: 1;">
                            ‚ñ∂Ô∏è Run Pipeline
                        </button>
                        <button class="btn btn-warning" onclick="runPipeline(true)" title="Regenerate all stages even if outputs exist">
                            üîÑ Force Rerun
                        </button>
                    </div>
                    <button class="btn btn-small" onclick="refreshPipelineStatus()" style="margin-bottom: 0.5rem;">
                        üîÑ Refresh Status
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="showOutputBrowser()" style="margin-bottom: 0.5rem;">
                        üìÇ Browse Outputs
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="exportProject()" title="Download entire project as zip">
                        üíæ Export Project
                    </button>
                    
                    <div id="pipelineStagesContainer" class="pipeline-status" style="margin-top: 1rem; display: none;">
                        <h4>Pipeline Status</h4>
                        <div id="pipelineStages"></div>
                        <div class="pipeline-log" id="pipelineLog" style="display: none;">
                            <h5>Recent Log <button class="btn-link" onclick="togglePipelineLog()">Toggle</button></h5>
                            <pre id="logContent"></pre>
                        </div>
                    </div>
                </div>

                <!-- Save Configuration -->
                <div class="config-section">
                    <h3>Export Formats</h3>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="exportFBX" checked> FBX</label>
                        <label><input type="checkbox" id="exportGLTF" checked> glTF</label>
                        <label><input type="checkbox" id="exportUSD"> USD</label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-secondary btn-block" onclick="saveConfig()">üíæ Save Config</button>
                </div>
            </div>
        </div>

        <!-- Pipeline Status Footer -->
        <footer class="status-bar" id="statusBar">
            <div class="status-content">
                <span id="statusText">Ready</span>
                <div class="status-indicators">
                    <span class="indicator" id="comfyStatus">ComfyUI: <span class="status-dot"></span></span>
                    <span class="indicator" id="pipelineStatus">Pipeline: <span class="status-dot"></span></span>
                </div>
            </div>
        </footer>
    </div>

    <!-- New Project Modal -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <h2>Create New Project</h2>
            <div class="form-group">
                <label for="newProjectName">Project Name</label>
                <input type="text" id="newProjectName" placeholder="MyCharacter" autofocus>
                <small>Alphanumeric, underscores, and hyphens only</small>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createNewProject()">Create</button>
            </div>
        </div>
    </div>

    <!-- Pipeline Progress Modal -->
    <div id="pipelineModal" class="modal">
        <div class="modal-content modal-large">
            <h2>Pipeline Progress</h2>
            <div id="pipelineSteps"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closePipelineModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Model Manager Modal -->
    <div id="modelManagerModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>ü§ñ ComfyUI Model Manager</h2>
                <button class="btn btn-secondary" onclick="closeModelManager()">‚úï</button>
            </div>
            
            <div class="model-manager-tabs">
                <button class="tab-btn active" onclick="switchModelTab('browse')">üìã Browse</button>
                <button class="tab-btn" onclick="switchModelTab('upload')">‚¨ÜÔ∏è Upload</button>
                <button class="tab-btn" onclick="switchModelTab('select')">‚öôÔ∏è Select Models</button>
            </div>
            
            <!-- Browse Tab -->
            <div id="browseTab" class="tab-content active">
                <div class="model-type-selector">
                    <label>Model Type:</label>
                    <select id="browseModelType" onchange="loadModelsForType(this.value)">
                        <option value="checkpoints">Checkpoints</option>
                        <option value="loras">LoRAs</option>
                        <option value="controlnet">ControlNet</option>
                        <option value="vae">VAE</option>
                        <option value="ipadapter">IP-Adapter</option>
                        <option value="embeddings">Embeddings</option>
                        <option value="upscale_models">Upscale Models</option>
                        <option value="clip_vision">CLIP Vision</option>
                    </select>
                    <button class="btn btn-small" onclick="refreshModelList()">üîÑ Refresh</button>
                </div>
                
                <div id="modelList" class="model-list">
                    <div class="loading">Loading models...</div>
                </div>
            </div>
            
            <!-- Upload Tab -->
            <div id="uploadTab" class="tab-content">
                <div class="upload-form">
                    <div class="form-group">
                        <label for="uploadModelType">Model Type</label>
                        <select id="uploadModelType">
                            <option value="checkpoints">Checkpoint (.safetensors, .ckpt)</option>
                            <option value="loras">LoRA (.safetensors, .ckpt)</option>
                            <option value="controlnet">ControlNet (.safetensors, .pth)</option>
                            <option value="vae">VAE (.safetensors, .pt)</option>
                            <option value="ipadapter">IP-Adapter (.safetensors, .bin)</option>
                            <option value="embeddings">Embedding (.safetensors, .pt)</option>
                            <option value="upscale_models">Upscale Model (.pth)</option>
                            <option value="clip_vision">CLIP Vision (.safetensors)</option>
                        </select>
                    </div>
                    
                    <div class="drop-zone" id="modelDropZone" 
                         ondrop="handleModelDrop(event)" 
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)">
                        <div class="drop-zone-content">
                            <span class="drop-icon">üì¶</span>
                            <p>Drop model file here</p>
                            <input type="file" id="modelFileInput" accept=".safetensors,.ckpt,.pt,.pth,.bin" onchange="handleModelFileSelect(event)" style="display: none">
                            <button class="btn btn-small" onclick="document.getElementById('modelFileInput').click()">Browse</button>
                        </div>
                    </div>
                    
                    <div id="modelUploadProgress" style="display: none; margin-top: 1rem;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="modelProgressFill"></div>
                        </div>
                        <p id="modelProgressText">Uploading...</p>
                    </div>
                    
                    <div class="model-info-panel">
                        <h4>üìù Model Guidelines</h4>
                        <ul>
                            <li><strong>Checkpoints:</strong> Base models (SDXL, SD 1.5, etc.)</li>
                            <li><strong>LoRAs:</strong> Style and character refinements</li>
                            <li><strong>ControlNet:</strong> Pose, depth, and structural control</li>
                            <li><strong>IP-Adapter:</strong> Image-based style transfer</li>
                        </ul>
                        <p><small>‚ö†Ô∏è Large files may take several minutes to upload</small></p>
                    </div>
                </div>
            </div>
            
            <!-- Select Models Tab -->
            <div id="selectTab" class="tab-content">
                <div class="workflow-selector">
                    <label>Workflow:</label>
                    <select id="workflowSelect" onchange="loadWorkflowModels(this.value)">
                        <option value="sprite_generation_enhanced">Enhanced Sprite Generation</option>
                        <option value="sprite_generation_workflow">Basic Sprite Generation</option>
                    </select>
                </div>
                
                <div id="workflowValidation" class="workflow-validation"></div>
                
                <div id="modelSelectors" class="model-selectors">
                    <!-- Dynamically populated -->
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="autoSelectWorkflowModels()">üîÑ Auto-Select</button>
                    <button class="btn btn-primary" onclick="saveWorkflowModelSelections()">üíæ Save Selections</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ComfyUI Setup Requirements Modal -->
    <div id="comfyUISetupModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>‚öôÔ∏è ComfyUI Setup Requirements</h2>
                <button class="close-btn" onclick="closeComfyUISetup()">&times;</button>
            </div>
            
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Custom Nodes Section -->
                <div class="setup-section">
                    <h3>üì¶ Required Custom Nodes</h3>
                    <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                        Install via ComfyUI Manager or manually. All nodes are free and open-source.
                    </p>
                    
                    <div class="node-list">
                        <div class="node-item">
                            <div class="node-header">
                                <span class="node-number">1</span>
                                <strong>ComfyUI-AnimateDiff-Evolved</strong>
                                <span class="node-badge">Required</span>
                            </div>
                            <p class="node-description">Temporal consistency across animation frames - prevents flickering</p>
                            <div class="node-details">
                                <div class="node-info">
                                    <strong>Manager:</strong> Search "AnimateDiff-Evolved" in ComfyUI Manager
                                </div>
                                <div class="node-info">
                                    <strong>Manual:</strong> <code>git clone https://github.com/Kosinkadink/ComfyUI-AnimateDiff-Evolved.git</code>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-item">
                            <div class="node-header">
                                <span class="node-number">2</span>
                                <strong>ComfyUI_IPAdapter_plus</strong>
                                <span class="node-badge">Required</span>
                            </div>
                            <p class="node-description">Character consistency from reference images - maintains style</p>
                            <div class="node-details">
                                <div class="node-info">
                                    <strong>Manager:</strong> Search "IPAdapter" in ComfyUI Manager
                                </div>
                                <div class="node-info">
                                    <strong>Manual:</strong> <code>git clone https://github.com/cubiq/ComfyUI_IPAdapter_plus.git</code>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-item">
                            <div class="node-header">
                                <span class="node-number">3</span>
                                <strong>comfyui_controlnet_aux</strong>
                                <span class="node-badge">Required</span>
                            </div>
                            <p class="node-description">ControlNet preprocessors - OpenPose, Depth, Normal, Canny maps</p>
                            <div class="node-details">
                                <div class="node-info">
                                    <strong>Manager:</strong> Search "controlnet_aux" in ComfyUI Manager
                                </div>
                                <div class="node-info">
                                    <strong>Manual:</strong> <code>git clone https://github.com/Fannovel16/comfyui_controlnet_aux.git</code>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-item">
                            <div class="node-header">
                                <span class="node-number">4</span>
                                <strong>ComfyUI-Advanced-ControlNet</strong>
                                <span class="node-badge">Required</span>
                            </div>
                            <p class="node-description">Advanced ControlNet features - weight scheduling, multi-ControlNet</p>
                            <div class="node-details">
                                <div class="node-info">
                                    <strong>Manager:</strong> Search "Advanced-ControlNet" in ComfyUI Manager
                                </div>
                                <div class="node-info">
                                    <strong>Manual:</strong> <code>git clone https://github.com/Kosinkadink/ComfyUI-Advanced-ControlNet.git</code>
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-item">
                            <div class="node-header">
                                <span class="node-number">5</span>
                                <strong>ComfyUI_essentials</strong>
                                <span class="node-badge">Required</span>
                            </div>
                            <p class="node-description">Background removal (RemBG node) + utility nodes</p>
                            <div class="node-details">
                                <div class="node-info">
                                    <strong>Manager:</strong> Search "essentials" in ComfyUI Manager
                                </div>
                                <div class="node-info">
                                    <strong>Manual:</strong> <code>git clone https://github.com/cubiq/ComfyUI_essentials.git</code>
                                </div>
                                <div class="node-info">
                                    <strong>Alternative:</strong> <code>pip install rembg[gpu]</code> (standalone package)
                                </div>
                            </div>
                        </div>
                        
                        <div class="node-item">
                            <div class="node-header">
                                <span class="node-number">6</span>
                                <strong>ComfyUI-Frame-Interpolation</strong>
                                <span class="node-badge optional">Optional</span>
                            </div>
                            <p class="node-description">Frame interpolation for smoother animations (60fps from 30fps, etc.)</p>
                            <div class="node-details">
                                <div class="node-info">
                                    <strong>Manager:</strong> Search "Frame Interpolation" in ComfyUI Manager
                                </div>
                                <div class="node-info">
                                    <strong>Manual:</strong> <code>git clone https://github.com/Fannovel16/ComfyUI-Frame-Interpolation.git</code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Models Section -->
                <div class="setup-section">
                    <h3>ü§ñ Required AI Models</h3>
                    <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                        Download models to appropriate ComfyUI directories. Total storage: ~20 GB
                    </p>
                    
                    <div class="model-category">
                        <h4>AnimateDiff Models</h4>
                        <p class="model-path"><strong>Directory:</strong> <code>ComfyUI/models/animatediff_models/</code></p>
                        <div class="model-item">
                            <div class="model-name">v3_sd15_mm.ckpt</div>
                            <div class="model-size">1.7 GB</div>
                            <div class="model-link">
                                <a href="https://huggingface.co/guoyww/animatediff/tree/main" target="_blank">Download from HuggingFace</a>
                            </div>
                            <p class="model-description">Motion model for temporal consistency</p>
                        </div>
                    </div>
                    
                    <div class="model-category">
                        <h4>IP-Adapter Models</h4>
                        <p class="model-path"><strong>Directory:</strong> <code>ComfyUI/models/ipadapter/</code></p>
                        <div class="model-item">
                            <div class="model-name">ip-adapter-faceid-plusv2_sd15.bin</div>
                            <div class="model-size">340 MB</div>
                            <div class="model-link">
                                <a href="https://huggingface.co/h94/IP-Adapter-FaceID/tree/main" target="_blank">Download from HuggingFace</a>
                            </div>
                            <p class="model-description">Character consistency from reference images</p>
                        </div>
                        
                        <p class="model-path" style="margin-top: 1rem;"><strong>Also needed in:</strong> <code>ComfyUI/models/clip_vision/</code></p>
                        <div class="model-item">
                            <div class="model-name">CLIP-ViT-H-14-laion2B-s32B-b79K.safetensors</div>
                            <div class="model-size">3.69 GB</div>
                            <div class="model-link">
                                <a href="https://huggingface.co/h94/IP-Adapter/tree/main/models/image_encoder" target="_blank">Download from HuggingFace</a>
                            </div>
                            <p class="model-description">Image encoder for IP-Adapter</p>
                        </div>
                    </div>
                    
                    <div class="model-category">
                        <h4>ControlNet Models</h4>
                        <p class="model-path"><strong>Directory:</strong> <code>ComfyUI/models/controlnet/</code></p>
                        
                        <div class="model-item">
                            <div class="model-name">control_v11p_sd15_openpose.pth</div>
                            <div class="model-size">1.45 GB</div>
                            <div class="model-link">
                                <a href="https://huggingface.co/lllyasviel/ControlNet-v1-1/tree/main" target="_blank">Download from HuggingFace</a>
                            </div>
                            <p class="model-description">Pose preservation - weight 0.9</p>
                        </div>
                        
                        <div class="model-item">
                            <div class="model-name">control_v11f1p_sd15_depth.pth</div>
                            <div class="model-size">1.45 GB</div>
                            <div class="model-link">
                                <a href="https://huggingface.co/lllyasviel/ControlNet-v1-1/tree/main" target="_blank">Download from HuggingFace</a>
                            </div>
                            <p class="model-description">Depth map guidance - weight 0.7</p>
                        </div>
                        
                        <div class="model-item">
                            <div class="model-name">control_v11p_sd15_normalbae.pth</div>
                            <div class="model-size">1.45 GB</div>
                            <div class="model-link">
                                <a href="https://huggingface.co/lllyasviel/ControlNet-v1-1/tree/main" target="_blank">Download from HuggingFace</a>
                            </div>
                            <p class="model-description">Normal map guidance - weight 0.5</p>
                        </div>
                        
                        <div class="model-item">
                            <div class="model-name">control_v11p_sd15_canny.pth</div>
                            <div class="model-size">1.45 GB</div>
                            <div class="model-link">
                                <a href="https://huggingface.co/lllyasviel/ControlNet-v1-1/tree/main" target="_blank">Download from HuggingFace</a>
                            </div>
                            <p class="model-description">Edge detection guidance - weight 0.4</p>
                        </div>
                    </div>
                    
                    <div class="model-category">
                        <h4>Base Checkpoints (Choose based on quality preset)</h4>
                        <p class="model-path"><strong>Directory:</strong> <code>ComfyUI/models/checkpoints/</code></p>
                        
                        <div class="model-item">
                            <div class="model-name">sd_xl_turbo_1.0_fp16.safetensors</div>
                            <div class="model-size">6.94 GB</div>
                            <div class="model-link">
                                <a href="https://huggingface.co/stabilityai/sdxl-turbo/tree/main" target="_blank">Download from HuggingFace</a>
                            </div>
                            <p class="model-description">Fast Prototype quality preset (~2-3 sec/frame)</p>
                        </div>
                        
                        <div class="model-item">
                            <div class="model-name">sdxl_lightning_4step.safetensors</div>
                            <div class="model-size">6.94 GB</div>
                            <div class="model-link">
                                <a href="https://huggingface.co/ByteDance/SDXL-Lightning/tree/main" target="_blank">Download from HuggingFace</a>
                            </div>
                            <p class="model-description">Balanced quality preset (~5-8 sec/frame) - Recommended</p>
                        </div>
                        
                        <div class="model-item">
                            <div class="model-name">sd_xl_base_1.0.safetensors</div>
                            <div class="model-size">6.94 GB</div>
                            <div class="model-link">
                                <a href="https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0/tree/main" target="_blank">Download from HuggingFace</a>
                            </div>
                            <p class="model-description">High/Ultra quality presets (~15-40 sec/frame)</p>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Reference -->
                <div class="setup-section">
                    <h3>üìã Quick Setup Checklist</h3>
                    <ul class="checklist">
                        <li>‚úÖ Install ComfyUI Manager (if not installed)</li>
                        <li>‚úÖ Install 5 required custom nodes + 1 optional</li>
                        <li>‚úÖ Download AnimateDiff motion model (1.7 GB)</li>
                        <li>‚úÖ Download IP-Adapter models (4 GB total)</li>
                        <li>‚úÖ Download ControlNet models (6 GB - all 4 models)</li>
                        <li>‚úÖ Download at least one base checkpoint (7 GB)</li>
                        <li>‚úÖ Restart ComfyUI after installing nodes</li>
                        <li>‚úÖ Test workflow with sample project</li>
                    </ul>
                    
                    <div class="setup-note">
                        <strong>üí° Tip:</strong> You can start with just SDXL-Lightning checkpoint for balanced quality/speed. 
                        Add SDXL-Turbo for fast prototyping or SDXL 1.0 for maximum quality later.
                    </div>
                    
                    <div class="setup-note" style="margin-top: 1rem;">
                        <strong>‚ö†Ô∏è VRAM Requirements:</strong>
                        <ul>
                            <li>Fast Prototype: ~4 GB VRAM</li>
                            <li>Balanced: ~6 GB VRAM</li>
                            <li>High Quality: ~8 GB VRAM</li>
                            <li>Ultra Quality: ~12 GB VRAM</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="window.open('https://github.com/Binkerton13/runpod-3d-ai-template/blob/main/COMFYUI_INSTALLATION.md', '_blank')">
                    üìñ Full Documentation
                </button>
                <button class="btn btn-primary" onclick="closeComfyUISetup()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Animation Prompt Editor Modal -->
    <div id="promptEditorModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Animation Prompts</h2>
                <button class="close-btn" onclick="closePromptEditor()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="prompt-editor-info">
                    <p>Edit prompts for selected animations. Changes can be saved as project overrides or global defaults.</p>
                </div>
                
                <div id="promptEditorContent" class="prompt-editor-content">
                    <!-- Dynamically populated with animation editors -->
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePromptEditor()">Cancel</button>
                <button class="btn btn-secondary" onclick="savePromptOverrides('project')">üíæ Save for Project</button>
                <button class="btn btn-primary" onclick="savePromptOverrides('global')">üåê Save as Defaults</button>
            </div>
        </div>
    </div>

    <!-- Output Browser Modal -->
    <div id="outputBrowserModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>üìÇ Output Files</h2>
                <button class="close-btn" onclick="closeOutputBrowser()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div id="outputBrowserContent" class="output-browser">
                    <div class="output-section">
                        <h3>üé® Textures</h3>
                        <div id="outputTextures" class="output-file-list"></div>
                    </div>
                    
                    <div class="output-section">
                        <h3>ü¶¥ Rigged Models</h3>
                        <div id="outputRigging" class="output-file-list"></div>
                    </div>
                    
                    <div class="output-section">
                        <h3>üé¨ Animations</h3>
                        <div id="outputAnimation" class="output-file-list"></div>
                    </div>
                    
                    <div class="output-section">
                        <h3>üì¶ Export Packages</h3>
                        <div id="outputExport" class="output-file-list"></div>
                    </div>
                    
                    <div class="output-section">
                        <h3>üñºÔ∏è Sprites</h3>
                        <div id="outputSprites" class="output-file-list"></div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeOutputBrowser()">Close</button>
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
    <script src="/static/mesh-selection.js"></script>
</body>
</html>
